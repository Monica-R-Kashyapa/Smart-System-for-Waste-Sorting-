
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <link rel="stylesheet" href="static/css/style.css">
    <style>
        #map { 
            height: 500px; 
        }
    </style>
</head>
<body>
    <div class="header-container">
        <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="Logo" class="logo">
        <h1>Smart system for waste sorting</h1>
        <p>Learn about waste categories and proper disposal methods to create a sustainable future.</p>
        <div class="button-container">
            <a href="/" class="button">Home</a>
        </div>
    </div>
    <header>
        <h1>Admin Dashboard</h1>
    </header>

    <div class="container">
        <header>
            <h2>Stored Location</h2>
        </header>
        <table border="1">
            <thead>
                <tr>
                    <th>Location name</th>
                    <th>Latitude</th>
                    <th>Longitude</th>
                    <th>Submitted By</th>
                    <th>Actions(Completed)</th>
                    <th>Remove Location</th>
                </tr>
            </thead>
            <tbody>
                {% for location in locations %}
                    <tr>
                        <td>{{ location.location_name }}</td>
                        <td>{{ location.latitude }}</td>
                        <td>{{ location.longitude }}</td>
                        <td>{{ location.username }}</td>
                        <td>
                            <input type="checkbox" class="completion-checkbox" data-id="{{ location.id }}" 
                                   {% if location.is_completed %}checked{% endif %}>
                        </td>
                        <td>
                            <form action="{{ url_for('delete_location', location_id=location.id) }}" method="POST" style="display:inline;">
                                <button type="submit" onclick="return confirm('Are you sure you want to delete this location?')">Delete</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Leaflet Map -->
    <div id="map"></div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
        // Initialize the map (centered at some default location)
        var map = L.map('map').setView([20.5937, 78.9629], 5);  // Default to India

        // Set up the tile layer for OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Locations data passed from Flask (the locations list)

        var locations = {{ locations | tojson }};
        console.log(locations);  // Debug to see the data in the browser's console
        let markers = {}; // Object to store markers by location ID

        // Function to create a marker icon
        function createIcon(color) {
            return L.icon({
                iconUrl: `http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`,
                iconSize: [25, 41],
                iconAnchor: [12, 41],
            });
        }


        // Add markers for each location
        locations.forEach(function (location) {
            const markerColor = location.is_completed ? "green" : "red";

            const marker = L.marker([location.latitude, location.longitude], {
                icon: createIcon(markerColor),
            }).addTo(map);

            marker.bindPopup(location.location_name); // Show location name on marker click
            markers[location.id] = marker; // Store the marker in the markers object
        });

        // Handle checkbox changes
        document.querySelectorAll('.completion-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const locationId = this.getAttribute('data-id');
                const isChecked = this.checked;

        // Send AJAX request to update the status
                fetch(`/update_completion/${locationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ is_completed: isChecked })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                    // Update marker color on the map
                        const marker = markers[locationId];
                        if (marker) {
                            const newColor = isChecked ? "green" : "red";
                            marker.setIcon(createIcon(newColor)); // Update marker icon
                        }
                    } else {
                        alert('Failed to update status.');
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    </script>
</body>
</html>